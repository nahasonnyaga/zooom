<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Thread - Threads 100</title>
  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ...existing styles... */
    .thread .thread-actions button.bookmarked {
      color: #ffd700;
    }
    .thread .thread-actions button.reposted {
      color: #43c25e;
    }
  </style>
</head>
<body>
  <div id="navbar"></div>
  <div class="layout-container">
    <main class="main-col">
      <h1>Post a New Thread</h1>
      <!-- ...search bar, must-login, and form as before... -->
      <div id="must-login" style="display:none;">
        <span>You must be logged in to post a new thread.</span><br/>
        <button class="login-btn" id="login-btn">Log In</button>
        <span>or</span>
        <button class="login-btn" id="signup-btn">Create Account</button>
      </div>
      <form id="post-form" style="display:none;">
        <!-- ...emoji picker, char count, textarea, tags, media, etc... -->
        <div class="emoji-picker" aria-label="Add emoji">
          <button type="button" class="emoji-btn" data-emoji="üòÄ" title="Grinning face">üòÄ</button>
          <button type="button" class="emoji-btn" data-emoji="üòÇ" title="Laughing">üòÇ</button>
          <button type="button" class="emoji-btn" data-emoji="üòç" title="Love">üòç</button>
          <button type="button" class="emoji-btn" data-emoji="üëç" title="Thumbs up">üëç</button>
          <button type="button" class="emoji-btn" data-emoji="üî•" title="Fire">üî•</button>
          <button type="button" class="emoji-btn" data-emoji="üéâ" title="Party">üéâ</button>
        </div>
        <span class="char-count" id="char-count">0/280</span>
        <textarea id="content" rows="5" placeholder="What's happening? Use #hashtags and @mentions." maxlength="280" required></textarea>
        <input class="tag-input" id="tags" type="text" maxlength="64" placeholder="Add tags or #hashtags, comma separated">
        <input type="file" id="media" accept="image/*,video/*" multiple style="display:block;margin-top:10px;" />
        <div id="media-preview"></div>
        <button type="submit"><i class="fa-solid fa-paper-plane"></i>&nbsp;Post</button>
        <div id="post-error"></div>
      </form>
      <div id="thread-feed" style="margin-top: 32px;"></div>
    </main>
    <aside class="sidebar-col">
      <!-- ...suggested users, suggested content, trending hashtags... -->
      <section class="suggested-section" id="suggested-users">
        <h3>Suggested Users to Follow</h3>
      </section>
      <section class="suggested-section">
        <h3>Suggested Content</h3>
        <ul class="suggested-content" id="suggested-content"></ul>
      </section>
      <section class="suggested-section">
        <h3>Trending Hashtags</h3>
        <ul class="hashtag-list" id="trending-hashtags"></ul>
      </section>
    </aside>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/post.js"></script>
  <script>
    // --- Auth Check ---
    let LOGGED_IN_USER = null;
    async function checkAuthAndToggleForm() {
      let user = null;
      try {
        const { data: { user: loggedInUser } } = await supabase.auth.getUser();
        user = loggedInUser;
      } catch (e) {
        user = null;
      }
      LOGGED_IN_USER = user;
      if (user) {
        document.getElementById('must-login').style.display = 'none';
        document.getElementById('post-form').style.display = '';
      } else {
        document.getElementById('must-login').style.display = '';
        document.getElementById('post-form').style.display = 'none';
      }
    }
    // ...existing DOMContentLoaded, emoji, charCount, mediaPreview, formValidation...

    // --- BOOKMARK, LIKE, REPOST: In-Memory Stores (Replace with backend for production) ---
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '{}');
    let likes = JSON.parse(localStorage.getItem('likes') || '{}');
    let reposts = JSON.parse(localStorage.getItem('reposts') || '{}');

    function toggleBookmark(threadId) {
      bookmarks[threadId] = !bookmarks[threadId];
      localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
      renderBookmarks();
    }
    function toggleLike(threadId, btn) {
      likes[threadId] = !likes[threadId];
      localStorage.setItem('likes', JSON.stringify(likes));
      if (btn) btn.classList.toggle('liked', likes[threadId]);
    }
    function toggleRepost(threadId, btn) {
      reposts[threadId] = !reposts[threadId];
      localStorage.setItem('reposts', JSON.stringify(reposts));
      if (btn) btn.classList.toggle('reposted', reposts[threadId]);
    }
    function renderBookmarks() {
      // Optionally show a list of bookmarks in the sidebar or a modal
    }

    // --- THREAD FEED LOADING WITH BOOKMARK, REPOST, LIKE ---
    window.__allThreads = [];
    async function loadThreads(searchQ) {
      const feed = document.getElementById('thread-feed');
      if (!feed) return;
      feed.innerHTML = 'Loading threads...';
      if (typeof supabase === "undefined") {
        feed.innerHTML = 'Thread loading requires Supabase setup.';
        return;
      }
      const { data: threads, error } = await supabase
        .from('threads')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);

      if (error) {
        feed.innerHTML = 'Failed to load threads.';
        return;
      }
      if (!threads || !threads.length) {
        feed.innerHTML = 'No threads yet. Be the first to post!';
        return;
      }

      window.__allThreads = threads;
      renderThreads(threads);
    }

    function renderThreads(threads) {
      const feed = document.getElementById('thread-feed');
      feed.innerHTML = threads.map((t, idx) => {
        const threadId = t.id || idx;
        const isBookmarked = bookmarks[threadId];
        const isLiked = likes[threadId];
        const isReposted = reposts[threadId];
        let tagHTML = "";
        if (t.tags) {
          tagHTML = `<div class="thread-tags">${t.tags.split(',').map(tag=>`<a class="hashtag-link" href="#" data-hashtag="${tag.trim().replace('#','')}">#${tag.trim().replace('#','')}</a>`).join(' ')}</div>`;
        }
        let metaHTML = `<div class="thread-meta"><i class="fa fa-user"></i> ${escapeHTML(t.user || 'Anon')} &nbsp; <i class="fa fa-clock"></i> ${t.created_at ? new Date(t.created_at).toLocaleString() : ''}</div>`;
        let commentsHTML = `
          <div class="thread-comments"></div>
          <form class="add-comment" data-thread-id="${threadId}">
            <input type="text" placeholder="Add a comment..." maxlength="140" required>
            <button type="submit"><i class="fa fa-paper-plane"></i></button>
          </form>
        `;
        return `<div class="thread" data-thread-id="${threadId}">
          ${metaHTML}
          <p>${linkify(escapeHTML(t.content))}</p>
          ${tagHTML}
          <div class="thread-actions">
            <button class="bookmark-btn${isBookmarked ? ' bookmarked' : ''}" title="Bookmark"><i class="fa fa-bookmark"></i></button>
            <button class="like-btn${isLiked ? ' liked' : ''}" title="Like"><i class="fa-solid fa-heart"></i> <span>0</span></button>
            <button class="repost-btn${isReposted ? ' reposted' : ''}" title="Repost"><i class="fa fa-retweet"></i></button>
            <button class="share-btn" title="Copy link"><i class="fa-solid fa-share-from-square"></i></button>
          </div>
          ${commentsHTML}
        </div>`;
      }).join('');
      // Handlers:
      feed.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.onclick = function() {
          const threadId = btn.closest('.thread').dataset.threadId;
          toggleBookmark(threadId);
          btn.classList.toggle('bookmarked');
        };
      });
      feed.querySelectorAll('.like-btn').forEach(btn => {
        btn.onclick = function() {
          const threadId = btn.closest('.thread').dataset.threadId;
          toggleLike(threadId, btn);
        };
      });
      feed.querySelectorAll('.repost-btn').forEach(btn => {
        btn.onclick = function() {
          const threadId = btn.closest('.thread').dataset.threadId;
          toggleRepost(threadId, btn);
          // Optionally: Add a "repost" to the user's feed
        };
      });
      feed.querySelectorAll('.share-btn').forEach(btn => {
        btn.onclick = function(e) {
          e.preventDefault();
          const threadId = btn.closest('.thread').dataset.threadId;
          const url = window.location.href + "#" + threadId;
          navigator.clipboard.writeText(url);
          btn.title = "Copied!";
          setTimeout(() => btn.title = "Copy link", 1200);
        };
      });
      feed.querySelectorAll('.add-comment').forEach(form => {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const threadId = form.getAttribute('data-thread-id');
          const input = form.querySelector('input');
          if (input.value.trim()) {
            addComment(threadId, input.value.trim());
            input.value = '';
          }
        });
      });
      // Hashtag links in threads
      feed.querySelectorAll('.hashtag-link').forEach(link => {
        link.onclick = (e) => {
          e.preventDefault();
          performSearch('#' + link.dataset.hashtag);
        };
      });
      Object.keys(threadComments).forEach(renderComments);
    }

    // --- Like/Bookmark/Repost helpers ---
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
      );
    }
    function linkify(text) {
      return text
        .replace(/(^|[^\w])#([a-zA-Z0-9_]+)/g, '$1<a class="hashtag-link" href="#" data-hashtag="$2">#$2</a>')
        .replace(/(^|[^\w])@([a-zA-Z0-9_]+)/g, '$1<a class="mention-link" href="?user=$2">@$2</a>');
    }

    // --- Comments logic (frontend demo) ---
    let threadComments = {};
    function addComment(threadId, comment, user='You') {
      if (!threadComments[threadId]) threadComments[threadId] = [];
      threadComments[threadId].push({ user, comment, time: new Date().toLocaleString() });
      renderComments(threadId);
    }
    function renderComments(threadId) {
      const threadElem = document.querySelector(`.thread[data-thread-id="${threadId}"]`);
      if (!threadElem) return;
      const commentsDiv = threadElem.querySelector('.thread-comments');
      if (!commentsDiv) return;
      const comments = threadComments[threadId] || [];
      commentsDiv.innerHTML = comments.map(
        c => `<div class="comment"><b>${c.user}:</b> ${escapeHTML(c.comment)}<br><small>${c.time}</small></div>`
      ).join('');
    }

    // --- On DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthAndToggleForm();
      renderSuggestedUsers();
      renderSuggestedContent();
      loadThreads();
    });
    // ...existing emoji picker, char count, media preview, search, trending hashtags, etc...
  </script>
</body>
</html>
