<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Authenticate - Zooom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="icon" href="assets/icon-192.png">
</head>
<body class="theme-light">
  <main>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="show-login">Log In</button>
        <button class="auth-tab" id="show-signup">Sign Up</button>
      </div>
      <!-- Login Form -->
      <form class="auth-form active" id="login-form" autocomplete="on">
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <button type="submit">Log In</button>
        <div class="auth-error" id="login-error"></div>
        <button type="button" class="reset-link" id="show-reset-modal">Forgot password?</button>
      </form>
      <!-- Signup Form -->
      <form class="auth-form" id="signup-form" autocomplete="on">
        <input type="email" id="signup-email" placeholder="Email" required>
        <input type="password" id="signup-password" placeholder="Password" required>
        <button type="submit">Sign Up</button>
        <div class="auth-error" id="signup-error"></div>
      </form>
      <!-- Switch Text -->
      <div class="auth-switch" id="switch-to-signup" style="display:none;">
        Don't have an account? <a href="#" id="switch-signup-link">Sign Up</a>
      </div>
      <div class="auth-switch" id="switch-to-login" style="display:none;">
        Already have an account? <a href="#" id="switch-login-link">Log In</a>
      </div>
    </div>
    <!-- Password Reset Modal -->
    <div class="reset-modal" id="resetModal">
      <div class="reset-modal-content">
        <button class="close-reset-modal" id="closeResetModal" title="Close">&times;</button>
        <h2>Reset Password</h2>
        <form id="reset-form" autocomplete="off">
          <input type="email" id="reset-email" placeholder="Enter your email" required>
          <button type="submit" id="resetBtn">Send Reset Link</button>
          <div class="reset-feedback" id="resetFeedback"></div>
          <div class="reset-error" id="resetError"></div>
        </form>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/theme.js"></script>
  <script>
    // Theme: keep theme in sync
    if (localStorage.getItem('zooom-theme') === 'dark') {
      document.body.classList.remove('theme-light');
      document.body.classList.add('theme-dark');
    }

    // Tab switch logic and tab param from URL
    const showLoginTab = document.getElementById('show-login');
    const showSignupTab = document.getElementById('show-signup');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const switchToSignup = document.getElementById('switch-to-signup');
    const switchToLogin = document.getElementById('switch-to-login');
    const switchSignupLink = document.getElementById('switch-signup-link');
    const switchLoginLink = document.getElementById('switch-login-link');
    function setTab(tab) {
      if (tab === 'signup') {
        showSignupTab.classList.add('active');
        showLoginTab.classList.remove('active');
        signupForm.classList.add('active');
        loginForm.classList.remove('active');
        switchToSignup.style.display = "none";
        switchToLogin.style.display = "block";
      } else {
        showLoginTab.classList.add('active');
        showSignupTab.classList.remove('active');
        loginForm.classList.add('active');
        signupForm.classList.remove('active');
        switchToSignup.style.display = "block";
        switchToLogin.style.display = "none";
      }
    }
    showLoginTab.onclick = () => setTab('login');
    showSignupTab.onclick = () => setTab('signup');
    if (switchSignupLink) switchSignupLink.onclick = (e) => { e.preventDefault(); setTab('signup'); };
    if (switchLoginLink) switchLoginLink.onclick = (e) => { e.preventDefault(); setTab('login'); };

    // Tab from URL param
    const params = new URLSearchParams(window.location.search);
    let tabParam = params.get('tab');
    setTab(tabParam === 'signup' ? 'signup' : 'login');

    // Login/Signup handlers with returnTo compatibility
    loginForm.onsubmit = async function(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');
      errorDiv.textContent = '';
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          errorDiv.textContent = error.message;
        } else {
          // Save username for navbar
          if (data.user && data.user.email) {
            localStorage.setItem('username', data.user.email.split('@')[0]);
          }
          // Redirect if returnTo is set
          const returnTo = params.get('returnTo');
          window.location.href = returnTo ? decodeURIComponent(returnTo) : 'index.html';
        }
      } catch (err) {
        errorDiv.textContent = "Unexpected error. Please try again.";
      }
    };

    signupForm.onsubmit = async function(e) {
      e.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const errorDiv = document.getElementById('signup-error');
      errorDiv.textContent = '';
      try {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) {
          errorDiv.textContent = error.message;
        } else {
          // Save username for navbar
          if (data.user && data.user.email) {
            localStorage.setItem('username', data.user.email.split('@')[0]);
          }
          // Redirect if returnTo is set
          const returnTo = params.get('returnTo');
          window.location.href = returnTo ? decodeURIComponent(returnTo) : 'index.html';
        }
      } catch (err) {
        errorDiv.textContent = "Unexpected error. Please try again.";
      }
    };

    // Password reset modal logic
    const resetModal = document.getElementById('resetModal');
    document.getElementById('show-reset-modal').onclick = function() {
      resetModal.classList.add('active');
      document.getElementById('resetFeedback').textContent = '';
      document.getElementById('resetError').textContent = '';
      document.getElementById('reset-email').value = '';
    };
    document.getElementById('closeResetModal').onclick = function() {
      resetModal.classList.remove('active');
    };
    window.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') resetModal.classList.remove('active');
    });
    resetModal.addEventListener('mousedown', function(e) {
      if (e.target === resetModal) resetModal.classList.remove('active');
    });

    document.getElementById('reset-form').onsubmit = async function(e) {
      e.preventDefault();
      const email = document.getElementById('reset-email').value;
      const feedbackDiv = document.getElementById('resetFeedback');
      const errorDiv = document.getElementById('resetError');
      const btn = document.getElementById('resetBtn');
      feedbackDiv.textContent = '';
      errorDiv.textContent = '';
      btn.disabled = true;
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + '/password-update.html'
        });
        if (error) {
          errorDiv.textContent = error.message || "Failed to send reset link.";
        } else {
          feedbackDiv.textContent = "Reset link sent! Check your email.";
        }
      } catch (err) {
        errorDiv.textContent = "Unexpected error. Please try again.";
      }
      btn.disabled = false;
    };
  </script>
</body>
</html>
