<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home | Zooom Forum</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Your personalized Zooom home.">
  <link rel="icon" href="assets/logo.png">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/theme.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .feed-tabs { display: flex; gap: 1.2em; margin-top: 1.5em; justify-content: center; }
    .feed-tab-btn { padding: 0.6em 1.2em;border-radius:18px;font-weight:600;background:#f3f7ff;color:#2b2b2b;border:none;cursor:pointer;font-size:1.05em;transition:background 0.15s;}
    .feed-tab-btn.active, .feed-tab-btn:focus { background: #2563eb; color: #fff; }
    .feed-tab-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .feed-ui-section { max-width: 600px; margin: 2em auto 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #0001; padding: 1.5em 2em; }
    .feed-ui-section h2 { margin-top: 0; }
    @media (max-width:650px) { .feed-ui-section { padding: 0.6em 0.1em; } .feed-tabs { flex-wrap: wrap; gap: 0.5em; } }
  </style>
</head>
<body class="theme-light">
  <div id="navbar"></div>
  <main>
    <div class="feed-tabs">
      <button class="feed-tab-btn active" id="tab-foryou" onclick="showTab('foryou')">For You</button>
      <button class="feed-tab-btn" id="tab-following" onclick="showTab('following')">Following</button>
      <button class="feed-tab-btn" id="tab-mentions" onclick="showTab('mentions')">Mentions</button>
      <button class="feed-tab-btn" id="tab-hashtags" onclick="showTab('hashtags')">#Hashtags</button>
      <button class="feed-tab-btn" id="tab-trending" onclick="showTab('trending')">Trending</button>
      <button class="feed-tab-btn" id="tab-newusers" onclick="showTab('newusers')">New Users</button>
      <button class="feed-tab-btn" id="tab-notifications" onclick="showTab('notifications')">Notifications</button>
      <button class="feed-tab-btn" id="tab-media" onclick="showTab('media')">Media</button>
    </div>
    <section class="feed-ui-section" id="section-foryou">
      <h2>For You</h2>
      <div id="foryou-feed">Loading personalized feed...</div>
    </section>
    <section class="feed-ui-section" id="section-following" style="display:none;">
      <h2>Following</h2>
      <div id="following-feed">Loading posts from users you follow...</div>
    </section>
    <section class="feed-ui-section" id="section-mentions" style="display:none;">
      <h2>Mentions</h2>
      <div id="mentions-feed">Loading posts where you are mentioned...</div>
    </section>
    <section class="feed-ui-section" id="section-hashtags" style="display:none;">
      <h2>#Hashtags</h2>
      <form id="hashtag-search-form" style="margin-bottom:1em;">
        <input type="text" id="hashtag-input" placeholder="Search hashtag..." style="padding:0.5em 1em;border-radius:16px;border:1px solid #cdd6e1;">
        <button type="submit" class="feed-tab-btn" style="padding:0.5em 1.2em;font-size:0.99em;">Search</button>
      </form>
      <div id="hashtags-feed">Enter a hashtag to search posts.</div>
    </section>
    <section class="feed-ui-section" id="section-trending" style="display:none;">
      <h2>Trending</h2>
      <div id="trending-feed">Loading trending topics...</div>
    </section>
    <section class="feed-ui-section" id="section-newusers" style="display:none;">
      <h2>New Users</h2>
      <div id="newusers-feed">Loading new users...</div>
    </section>
    <section class="feed-ui-section" id="section-notifications" style="display:none;">
      <h2>Notifications</h2>
      <div id="notifications-feed">Loading notifications...</div>
    </section>
    <section class="feed-ui-section" id="section-media" style="display:none;">
      <h2>Media</h2>
      <div id="media-feed">Loading posts with media...</div>
    </section>
    <section class="feed-ui-section" style="margin-bottom:2.5em;">
      <form id="logout-form">
        <button type="submit" class="feed-tab-btn" style="background:#f43f5e;color:#fff;">Logout</button>
      </form>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/theme.js"></script>
  <script>
    // Inject navbar and theme
    fetch('components/navbar.html').then(r => r.text()).then(html => {
      document.getElementById('navbar').innerHTML = html;
      if(window.lucide) lucide.createIcons();
    });
    if(localStorage.getItem('zooom-theme')==='dark') {
      document.body.classList.remove('theme-light');
      document.body.classList.add('theme-dark');
    }

    function showTab(tab) {
      const tabs = ['foryou','following','mentions','hashtags','trending','newusers','notifications','media'];
      tabs.forEach(t=>{
        document.getElementById('section-'+t).style.display = t===tab?'block':'none';
        document.getElementById('tab-'+t).classList.toggle('active', t===tab);
      });
    }

    // Efficient FEED LOADING LOGIC using Supabase.js (window.supabase)
    document.addEventListener('DOMContentLoaded', async () => {
      // FOR YOU: All recent posts, personalized (could be improved with ML, here just recent for demo)
      const { data: forYouPosts } = await window.supabase
        .from('posts')
        .select('*, profiles:profiles!posts_user_id_fkey(username,display_name,avatar_url)')
        .order('created_at', { ascending: false })
        .limit(20);
      document.getElementById('foryou-feed').innerHTML = forYouPosts && forYouPosts.length
        ? forYouPosts.map(post => `
            <div class="feed-post-card" style="margin-bottom:1.2em;">
              <div style="display:flex;align-items:center;gap:0.7em;">
                <img src="${post.profiles?.avatar_url || 'assets/avatar.png'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                <div>
                  <b>${post.profiles?.display_name || post.profiles?.username || "User"}</b>
                  <span style="color:#888;font-size:0.97em;">@${post.profiles?.username || "user"}</span>
                </div>
              </div>
              <a href="thread.html?id=${post.id}" style="text-decoration:none;">
                <div style="margin-top:0.7em;font-size:1.14em;line-height:1.55;">
                  <b>${post.title ? post.title : '(no title)'}</b>
                </div>
              </a>
              <div style="color:#888;margin-top:0.4em;font-size:0.97em;">
                ${new Date(post.created_at).toLocaleString()}
              </div>
              ${post.topic ? `<div style="color:#2563eb;margin-top:0.3em;">#${post.topic}</div>` : ""}
            </div>
          `).join('')
        : '<div style="color:#888;">No posts found.</div>';

      // FOLLOWING: Only show posts from users the current user follows
      let currentUser = await window.getCurrentUser();
      if (currentUser) {
        const { data: follows } = await window.supabase
          .from('follows')
          .select('following_id')
          .eq('follower_id', currentUser.id);
        const followingIds = follows ? follows.map(f => f.following_id) : [];
        let posts = [];
        if (followingIds.length) {
          const { data } = await window.supabase
            .from('posts')
            .select('*, profiles:profiles!posts_user_id_fkey(username,display_name,avatar_url)')
            .in('user_id', followingIds)
            .order('created_at', { ascending: false })
            .limit(20);
          posts = data || [];
        }
        document.getElementById('following-feed').innerHTML = posts.length
          ? posts.map(post => `
              <div class="feed-post-card" style="margin-bottom:1.2em;">
                <div style="display:flex;align-items:center;gap:0.7em;">
                  <img src="${post.profiles?.avatar_url || 'assets/avatar.png'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                  <div>
                    <b>${post.profiles?.display_name || post.profiles?.username || "User"}</b>
                    <span style="color:#888;font-size:0.97em;">@${post.profiles?.username || "user"}</span>
                  </div>
                </div>
                <a href="thread.html?id=${post.id}" style="text-decoration:none;">
                  <div style="margin-top:0.7em;font-size:1.14em;line-height:1.55;">
                    <b>${post.title ? post.title : '(no title)'}</b>
                  </div>
                </a>
                <div style="color:#888;margin-top:0.4em;font-size:0.97em;">
                  ${new Date(post.created_at).toLocaleString()}
                </div>
                ${post.topic ? `<div style="color:#2563eb;margin-top:0.3em;">#${post.topic}</div>` : ""}
              </div>
            `).join('')
          : '<div style="color:#888;">No posts from users you follow.</div>';
      } else {
        document.getElementById('following-feed').innerHTML = `<a href="login.html" style="color:#2563eb;">Sign in to see your following feed.</a>`;
      }

      // MENTIONS: Posts where user is mentioned (simple: @username in body)
      if (currentUser) {
        const { data: profile } = await window.supabase
          .from('profiles')
          .select('username')
          .eq('id', currentUser.id)
          .single();
        const username = profile?.username;
        if (username) {
          const { data: mentionPosts } = await window.supabase
            .from('posts')
            .select('*, profiles:profiles!posts_user_id_fkey(username,display_name,avatar_url)')
            .ilike('body', `%@${username}%`)
            .order('created_at', { ascending: false })
            .limit(20);
          document.getElementById('mentions-feed').innerHTML = mentionPosts && mentionPosts.length
            ? mentionPosts.map(post => `
                <div class="feed-post-card" style="margin-bottom:1.2em;">
                  <div style="display:flex;align-items:center;gap:0.7em;">
                    <img src="${post.profiles?.avatar_url || 'assets/avatar.png'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                    <div>
                      <b>${post.profiles?.display_name || post.profiles?.username || "User"}</b>
                      <span style="color:#888;font-size:0.97em;">@${post.profiles?.username || "user"}</span>
                    </div>
                  </div>
                  <a href="thread.html?id=${post.id}" style="text-decoration:none;">
                    <div style="margin-top:0.7em;font-size:1.14em;line-height:1.55;">
                      <b>${post.title ? post.title : '(no title)'}</b>
                    </div>
                  </a>
                  <div style="color:#888;margin-top:0.4em;font-size:0.97em;">
                    ${new Date(post.created_at).toLocaleString()}
                  </div>
                  ${post.topic ? `<div style="color:#2563eb;margin-top:0.3em;">#${post.topic}</div>` : ""}
                </div>
              `).join('')
            : '<div style="color:#888;">No recent posts mentioning you.</div>';
        }
      } else {
        document.getElementById('mentions-feed').innerHTML = `<a href="login.html" style="color:#2563eb;">Sign in to see mentions.</a>`;
      }

      // HASHTAGS: On search
      document.getElementById('hashtag-search-form').onsubmit = async function(e) {
        e.preventDefault();
        const tag = document.getElementById('hashtag-input').value.trim().replace(/^#/, '');
        if (!tag) return;
        document.getElementById('hashtags-feed').textContent = "Searching...";
        const { data: tagPosts } = await window.supabase
          .from('posts')
          .select('*, profiles:profiles!posts_user_id_fkey(username,display_name,avatar_url)')
          .ilike('topic', `%${tag}%`)
          .order('created_at', { ascending: false })
          .limit(20);
        document.getElementById('hashtags-feed').innerHTML = tagPosts && tagPosts.length
          ? tagPosts.map(post => `
              <div class="feed-post-card" style="margin-bottom:1.2em;">
                <div style="display:flex;align-items:center;gap:0.7em;">
                  <img src="${post.profiles?.avatar_url || 'assets/avatar.png'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                  <div>
                    <b>${post.profiles?.display_name || post.profiles?.username || "User"}</b>
                    <span style="color:#888;font-size:0.97em;">@${post.profiles?.username || "user"}</span>
                  </div>
                </div>
                <a href="thread.html?id=${post.id}" style="text-decoration:none;">
                  <div style="margin-top:0.7em;font-size:1.14em;line-height:1.55;">
                    <b>${post.title ? post.title : '(no title)'}</b>
                  </div>
                </a>
                <div style="color:#888;margin-top:0.4em;font-size:0.97em;">
                  ${new Date(post.created_at).toLocaleString()}
                </div>
                <div style="color:#2563eb;margin-top:0.3em;">#${post.topic}</div>
              </div>
            `).join('')
          : '<div style="color:#888;">No posts with this hashtag.</div>';
      };

      // TRENDING: Most frequent topics
      const { data: trending } = await window.supabase
        .from('trends')
        .select('*')
        .order('rank', { ascending: true })
        .limit(10);
      document.getElementById('trending-feed').innerHTML = trending && trending.length
        ? trending.map(t => `<div style="margin-bottom:0.7em;"><b>#${t.topic}</b> <span style="color:#888;">(${t.post_count} posts)</span></div>`).join('')
        : '<div style="color:#888;">No trending topics.</div>';

      // NEW USERS
      const { data: users } = await window.supabase
        .from('profiles')
        .select('username,display_name,avatar_url,created_at')
        .order('created_at', { ascending: false })
        .limit(10);
      document.getElementById('newusers-feed').innerHTML = users && users.length
        ? users.map(u => `
            <div style="display:flex;align-items:center;gap:0.8em;margin-bottom:0.95em;">
              <img src="${u.avatar_url || 'assets/avatar.png'}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
              <a href="profile.html?user=${encodeURIComponent(u.username)}"><b>${u.display_name || u.username}</b></a>
              <span style="color:#888;font-size:0.96em;">@${u.username}</span>
            </div>
          `).join('')
        : '<div style="color:#888;">No new users.</div>';

      // NOTIFICATIONS: Only for logged-in user
      if (currentUser) {
        const { data: notifications } = await window.supabase
          .from('notifications')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(20);
        document.getElementById('notifications-feed').innerHTML = notifications && notifications.length
          ? notifications.map(n => `
              <div style="margin-bottom:1em;">
                <b>${n.type}</b> - <span style="color:#888;">${new Date(n.created_at).toLocaleString()}</span><br>
                <span style="color:#222;">${n.data ? JSON.stringify(n.data) : ''}</span>
              </div>
            `).join('')
          : '<div style="color:#888;">No notifications.</div>';
      } else {
        document.getElementById('notifications-feed').innerHTML = `<a href="login.html" style="color:#2563eb;">Sign in to see notifications.</a>`;
      }

      // MEDIA: Posts with media_url
      const { data: mediaPosts } = await window.supabase
        .from('posts')
        .select('*, profiles:profiles!posts_user_id_fkey(username,display_name,avatar_url)')
        .not('media_url','is',null)
        .order('created_at', { ascending: false })
        .limit(20);
      document.getElementById('media-feed').innerHTML = mediaPosts && mediaPosts.length
        ? mediaPosts.map(post => `
            <div class="feed-post-card" style="margin-bottom:1.2em;">
              <div style="display:flex;align-items:center;gap:0.7em;">
                <img src="${post.profiles?.avatar_url || 'assets/avatar.png'}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
                <div>
                  <b>${post.profiles?.display_name || post.profiles?.username || "User"}</b>
                  <span style="color:#888;font-size:0.97em;">@${post.profiles?.username || "user"}</span>
                </div>
              </div>
              <a href="thread.html?id=${post.id}" style="text-decoration:none;">
                <div style="margin-top:0.7em;font-size:1.14em;line-height:1.55;">
                  <b>${post.title ? post.title : '(no title)'}</b>
                </div>
              </a>
              <div style="margin:0.8em 0;">
                <img src="${post.media_url}" style="max-width:90%;border-radius:12px;">
              </div>
              <div style="color:#888;margin-top:0.4em;font-size:0.97em;">
                ${new Date(post.created_at).toLocaleString()}
              </div>
              ${post.topic ? `<div style="color:#2563eb;margin-top:0.3em;">#${post.topic}</div>` : ""}
            </div>
          `).join('')
        : '<div style="color:#888;">No posts with media.</div>';

      // LOGOUT
      document.getElementById('logout-form').onsubmit = async function(e) {
        e.preventDefault();
        await window.supabase.auth.signOut();
        window.location.href = "login.html";
      };
    });
  </script>
</body>
</html>
